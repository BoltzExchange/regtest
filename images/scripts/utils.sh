#!/usr/bin/env bash
BITCOIN_CLI_PARAMS="-rpcconnect=bitcoind -regtest -rpccookiefile=/root/.bitcoin/regtest/.cookie"

function bitcoin-cli-sim() {
  bitcoin-cli $BITCOIN_CLI_PARAMS "$@"
}

function bitcoin-cli-sim-server() {
  bitcoin-cli $BITCOIN_CLI_PARAMS -rpcwallet="regtest" "$@"
}

function bitcoin-cli-sim-client() {
  bitcoin-cli $BITCOIN_CLI_PARAMS -rpcwallet="client" "$@"
}

ELEMENTS_CLI_PARAMS="-rpcconnect=elementsd"
function elements-cli-sim() {
  elements-cli $ELEMENTS_CLI_PARAMS "$@"
}

function elements-cli-sim-server() {
  elements-cli $ELEMENTS_CLI_PARAMS -rpcwallet="regtest" "$@"
}

function elements-cli-sim-client() {
  elements-cli $ELEMENTS_CLI_PARAMS -rpcwallet="client" "$@"
}

#backwards compat
boltzcli-sim() {
  boltzcli --datadir=/root/.boltz-client --host boltz-client "$@"
}

boltz-client-cli-sim() {
  boltzcli-sim "$@"
}

# args(i, cmd)
lightning-cli-sim() {
  i=$1
  shift # shift first argument so we can use $@
  lightning-cli --network regtest --lightning-dir=/root/.lightning-"$i" "$@"
}

# args(i, cmd)
lncli-sim() {
  i=$1
  shift # shift first argument so we can use $@
  lncli --network regtest --rpcserver=lnd-$i:10009 --lnddir=/root/.lnd-"$i" "$@"
}

# client/backend convenience wrappers
lightning-cli-sim-client() {
  lightning-cli-sim 1 "$@"
}

lightning-cli-sim-server() {
  lightning-cli-sim 2 "$@"
}

lncli-sim-client() {
  lncli-sim 1 "$@"
}

lncli-sim-server() {
  lncli-sim 2 "$@"
}

arkd-sim() {
  arkd --url http://arkd:7071 "$@"
}

# args(i)
fund_cln_node() {
  address=$(lightning-cli-sim $1 newaddr | jq -r .p2tr)
  echo "funding: $address on cln-node: $1"
  bitcoin-cli-sim-server -named sendtoaddress address=$address amount=30 fee_rate=1 > /dev/null
}

# args(i)
fund_lnd_node() {
  address=$(lncli-sim $1 newaddress p2wkh | jq -r .address)
  echo "funding: $address on lnd-node: $1"
  bitcoin-cli-sim-server -named sendtoaddress address=$address amount=30 fee_rate=1 > /dev/null
}

# args(i, j)
connect_cln_node() {
  pubkey=$(lightning-cli-sim $2 getinfo | jq -r '.id')
  lightning-cli-sim $1 connect $pubkey@cln-$2:9735 | jq -r '.id'
}

bitcoind-init() {
  # Wait until bitcoind is ready
  while true; do
      sleep 1
      if bitcoin-cli-sim-server getblockchaininfo &> /dev/null; then
          echo "bitcoind is ready"
          break
      else
          echo "Waiting for bitcoind to initialize..."
      fi
  done

  bitcoin-cli-sim createwallet regtest || bitcoin-cli-sim loadwallet regtest
  # Generate 150 blocks
  bitcoin-cli-sim-server -generate 150

  if [ $? -eq 0 ]; then
      echo "Successfully generated blocks"
  else
      echo "Failed to generate blocks"
  fi

  bitcoin-cli-sim createwallet client || bitcoin-cli-sim loadwallet client

  CLIENT_ADDRESS=$(bitcoin-cli-sim-client getnewaddress "" bech32m)
  bitcoin-cli-sim-server -rpcwallet=regtest sendtoaddress $CLIENT_ADDRESS 10
  bitcoin-cli-sim-server -rpcwallet=regtest -generate 1
}

# Needed for hold plugin to get the hooks first
restart_offer_plugin() {
    lightning-cli-sim $1 plugin stop /usr/libexec/c-lightning/plugins/offers
    lightning-cli-sim $1 plugin start /usr/libexec/c-lightning/plugins/offers
}

regtest-start(){
  deploy_contracts

  restart_offer_plugin 1
  restart_offer_plugin 2

  regtest-init
}

elements-init(){
  elements-cli-sim createwallet regtest || elements-cli-sim loadwallet regtest true
  echo "mining 150 liquid blocks..."
  elements-cli-sim-server -generate 150 > /dev/null
  elements-cli-sim-server rescanblockchain 0 > /dev/null

  elements-cli-sim createwallet client || elements-cli-sim loadwallet client true

  CLIENT_ADDRESS=$(elements-cli-sim -rpcwallet=client getnewaddress)
  elements-cli-sim-server -rpcwallet=regtest sendtoaddress $CLIENT_ADDRESS 10

  # First wpkh_slip77 address of "abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"
  elements-cli-sim-server -rpcwallet=regtest sendtoaddress el1qq2xvpcvfup5j8zscjq05u2wxxjcyewk7979f3mmz5l7uw5pqmx6xf5xy50hsn6vhkm5euwt72x878eq6zxx2z0z676mna6kdq 10

  elements-cli-sim-server -rpcwallet=regtest -generate 1
}

waitForArkdToSync(){
  while ! arkd-sim wallet balance > /dev/null 2>&1; do
    sleep 1
  done

  echo "arkd synced"
}

arkd-init(){
  echo "creating arkd wallet"
  echo "waiting for arkd to be ready..."
  while ! curl -s http://arkd:7070 > /dev/null 2>&1; do
    sleep 1
  done
  echo "arkd is ready"

  arkd-sim wallet create --password ark
  arkd-sim wallet unlock --password ark
  waitForArkdToSync

  bitcoin-cli-sim-server -rpcwallet=regtest sendtoaddress $(arkd-sim wallet address) 25
  bitcoin-cli-sim-server -rpcwallet=regtest -generate 1
  echo "funded arkd"

  while ! curl -sf http://arkd:7070/v1/info > /dev/null 2>&1; do
    sleep 1
  done
}

fulmine-init(){
  echo "creating fulmine wallet"
  curl -s -X POST http://fulmine:7001/api/v1/wallet/create \
    -H "Content-Type: application/json" \
    -d '{"private_key": "693b0b993e69953c35838e96c8c41430e0ae881c2faa1bc95e203cdaec5f3fdf", "password": "ark", "server_url": "http://arkd:7070"}'

  curl -s -X POST http://fulmine:7001/api/v1/wallet/unlock \
    -H "Content-Type: application/json" \
    -d '{"password": "ark"}' > /dev/null

  echo "funding fulmine"
  
  while true; do
    fulmineAddress=$(curl -s -X GET http://fulmine:7001/api/v1/address | jq -r .address)
    if [ ! -z "$fulmineAddress" ] && [ "$fulmineAddress" != "null" ]; then
      echo "fulmine address: $fulmineAddress"
      fulmineAddress=${fulmineAddress#bitcoin:}
      echo "fulmine address: $fulmineAddress"
      fulmineAddress=${fulmineAddress%%\?*}
      echo "fulmine address: $fulmineAddress"
      break
    fi
    sleep 1
  done

  bitcoin-cli-sim-server -rpcwallet=regtest sendtoaddress $fulmineAddress 1
  bitcoin-cli-sim-server -rpcwallet=regtest -generate 1

  echo "waiting for fulmine transactions..."
  while true; do
    txCount=$(curl -s -X GET http://fulmine:7001/api/v1/transactions | jq -r '.transactions | length')
    if [ ! -z "$txCount" ] && [ "$txCount" -gt 0 ]; then
      echo "fulmine has $txCount transaction(s)"
      break
    fi
    sleep 1
  done

  echo "settling fulmine..."
  curl -s -X GET http://fulmine:7001/api/v1/settle
  echo "fulmine settled"
}

regtest-init(){
  elements-init
  lightning-sync
  lightning-init

  if [[ "$COMPOSE_PROFILES" == *"backend-dev"* ]] || [[ "$COMPOSE_PROFILES" == *"ark"* ]]; then
    echo "ark profile detected, waiting for arkd..."
    while ! timeout 1 bash -c 'cat < /dev/null > /dev/tcp/arkd/7070' 2>/dev/null; do
      echo "waiting for arkd to be ready..."
      sleep 1
    done
    echo "arkd is available"
    arkd-init
    fulmine-init
  else
    echo "arkd not in active profiles; skipping arkd/fulmine init"
  fi
}

lightning-sync(){
  wait-for-cln-sync 1
  wait-for-cln-sync 2
  wait-for-lnd-sync 1
  wait-for-lnd-sync 2
}

lightning-init(){
  # create 10 UTXOs for each node
  for i in 0 1 2 3 4; do
    fund_cln_node 1
    fund_cln_node 2
    fund_lnd_node 1
    fund_lnd_node 2
  done

  echo "mining 3 blocks..."
  bitcoin-cli-sim-server -generate 3 > /dev/null

  lightning-sync

  channel_confirms=6
  channel_size=24000000 # 0.024 btc
  balance_size=12000000 # 0.12 btc
  balance_size_msat=12000000000 # 0.12 btc

  # lnd-1 -> lnd-2
  lncli-sim 1 connect $(lncli-sim 2 getinfo | jq -r '.identity_pubkey')@lnd-2 > /dev/null
  echo "open channel from lnd-1 to lnd-2"
  lncli-sim 1 openchannel $(lncli-sim 2 getinfo | jq -r '.identity_pubkey') $channel_size $balance_size > /dev/null
  bitcoin-cli-sim-server -generate $channel_confirms > /dev/null
  wait-for-lnd-channel 1
  lightning-sync

  # lnd-1 -> cln-1
  lncli-sim 1 connect $(lightning-cli-sim 1 getinfo | jq -r '.id')@cln-1 > /dev/null
  echo "open channel from lnd-1 to cln-1"
  lncli-sim 1 openchannel $(lightning-cli-sim 1 getinfo | jq -r '.id') $channel_size $balance_size > /dev/null
  bitcoin-cli-sim-server -generate $channel_confirms > /dev/null
  wait-for-lnd-channel 1
  lightning-sync

  # lnd-2 -> cln-1
  lncli-sim 2 connect $(lightning-cli-sim 1 getinfo | jq -r '.id')@cln-1 > /dev/null
  echo "open channel from lnd-2 to cln-1"
  lncli-sim 2 openchannel $(lightning-cli-sim 1 getinfo | jq -r '.id') $channel_size $balance_size > /dev/null
  bitcoin-cli-sim-server -generate $channel_confirms > /dev/null
  wait-for-lnd-channel 2
  wait-for-cln-channel 1
  lightning-sync

  # lnd-1 -> cln-2
  lncli-sim 1 connect $(lightning-cli-sim 2 getinfo | jq -r '.id')@cln-2 > /dev/null
  echo "open channel from lnd-1 to cln-2"
  lncli-sim 1 openchannel $(lightning-cli-sim 2 getinfo | jq -r '.id') $channel_size $balance_size > /dev/null
  bitcoin-cli-sim-server -generate $channel_confirms > /dev/null
  wait-for-lnd-channel 1
  wait-for-cln-channel 2
  lightning-sync

  # lnd-2 -> cln-2
  lncli-sim 2 connect $(lightning-cli-sim 2 getinfo | jq -r '.id')@cln-2 > /dev/null
  echo "open channel from lnd-2 to cln-2"
  lncli-sim 2 openchannel $(lightning-cli-sim 2 getinfo | jq -r '.id') $channel_size $balance_size > /dev/null
  bitcoin-cli-sim-server -generate $channel_confirms > /dev/null
  wait-for-lnd-channel 2
  wait-for-cln-channel 2

  # cln-1 -> cln-2 P2P connection for offer fetching
  lightning-cli-sim 1 connect $(lightning-cli-sim 2 getinfo | jq -r '.id')@cln-2:9735

  lightning-sync

}

wait-for-lnd-channel(){
  while true; do
    pending=$(lncli-sim $1 pendingchannels | jq -r '.pending_open_channels | length')
    echo "lnd-$1 pendingchannels: $pending"
    if [[ "$pending" == "0" ]]; then
      break
    fi
    sleep 1
  done
}

wait-for-lnd-sync(){
  while true; do
    if [[ "$(lncli-sim $1 getinfo 2>&1 | jq -r '.synced_to_chain' 2> /dev/null)" == "true" ]]; then
      echo "lnd-$1 is synced!"
      break
    fi
    echo "waiting for lnd-$1 to sync..."
    sleep 1
  done
}

wait-for-cln-channel(){
  while true; do
    pending=$(lightning-cli-sim $1 getinfo | jq -r '.num_pending_channels | length')
    echo "cln-$1 pendingchannels: $pending"
    if [[ "$pending" == "0" ]]; then
      if [[ "$(lightning-cli-sim $1 getinfo 2>&1 | jq -r '.warning_bitcoind_sync' 2> /dev/null)" == "null" ]]; then
        if [[ "$(lightning-cli-sim $1 getinfo 2>&1 | jq -r '.warning_lightningd_sync' 2> /dev/null)" == "null" ]]; then
          break
        fi
      fi
    fi
    sleep 1
  done
}

wait-for-cln-sync(){
  while true; do
    if [[ "$(lightning-cli-sim $1 getinfo 2>&1 | jq -r '.warning_bitcoind_sync' 2> /dev/null)" == "null" ]]; then
      if [[ "$(lightning-cli-sim $1 getinfo 2>&1 | jq -r '.warning_lightningd_sync' 2> /dev/null)" == "null" ]]; then
        echo "cln-$1 is synced!"
        break
      fi
    fi
    echo "waiting for cln-$1 to sync..."
    sleep 1
  done
}

# Deploy contracts
deploy_contract() {
  cast send --rpc-url http://anvil:8545 --private-key 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d --create $1
}

deploy_contracts() {
  # EtherSwap
  deploy_contract 0x7f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60c09081527f0f435efbd794bc89b372127f0e96dcc927b729642a259c9b4dcbab48b107caec60e0527fe455bf8ea6e7463a1046a0b52804526e119b4bf5136279614e0b1e8e296a4e2d610100524661012052306101405260a0808052610160604052902060805234801561009457600080fd5b506080516118ed6100c5600039600081816101f60152818161057f015281816107150152610c2b01526118ed6000f3fe6080604052600436106101755760003560e01c8063a9ab4d5b116100cb578063eb84e7f21161007f578063fb35dd9611610059578063fb35dd9614610481578063fe237d45146104a1578063ffa1ad74146104c157600080fd5b8063eb84e7f2146103fd578063ebb7af921461042d578063f3382d571461046157600080fd5b8063c2c3a8c9116100b0578063c2c3a8c91461039d578063c3c37fbc146103bd578063cd413efa146103dd57600080fd5b8063a9ab4d5b14610349578063b2b78df81461037d57600080fd5b8063365047211161012d5780636fa4ae60116101075780636fa4ae60146102e1578063799f212b146102f45780638b2f8f821461030757600080fd5b8063365047211461026b5780635073c2771461028b57806354fd4d50146102bf57600080fd5b806335cd4ccb1161015e57806335cd4ccb146101c45780633644e515146101e45780633648a8071461022657600080fd5b80630685d21e1461017a5780630899146b146101af575b600080fd5b34801561018657600080fd5b5061019a6101953660046113f2565b6104d6565b60405190151581526020015b60405180910390f35b6101c26101bd36600461146a565b610686565b005b3480156101d057600080fd5b506101c26101df3660046114a2565b610698565b3480156101f057600080fd5b506102187f000000000000000000000000000000000000000000000000000000000000000081565b6040519081526020016101a6565b34801561023257600080fd5b506102466102413660046114e1565b6106ab565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016101a6565b34801561027757600080fd5b506101c2610286366004611547565b61083b565b34801561029757600080fd5b506102187f09a36cedee5cdca9c8804bc3bd501c303082427c9156e7b1f46a65c28e17ce5881565b3480156102cb57600080fd5b5060065b60405160ff90911681526020016101a6565b6101c26102ef366004611599565b610889565b6101c26103023660046115d6565b6108e2565b34801561031357600080fd5b50610218610322366004611547565b604080519586526020860194909452928401919091526060830152608082015260a0902090565b34801561035557600080fd5b506102187fb58a7c79b5c8052bb2d380096e39f2ed848c68cdd21cb69f6ab5152ade26292681565b34801561038957600080fd5b506101c26103983660046113f2565b6108ef565b3480156103a957600080fd5b506101c26103b836600461165a565b610913565b3480156103c957600080fd5b506101c26103d83660046114a2565b6109c3565b3480156103e957600080fd5b506101c26103f8366004611547565b6109cc565b34801561040957600080fd5b5061019a610418366004611731565b60006020819052908152604090205460ff1681565b34801561043957600080fd5b506102187fad247288102f13699d9a6cafb9cfb8fce14f10334c0f638ba03889ab655fc6e681565b34801561046d57600080fd5b506101c261047c36600461174a565b6109e3565b34801561048d57600080fd5b506101c261049c3660046113f2565b610b8b565b3480156104ad57600080fd5b506101c26104bc3660046114e1565b610da4565b3480156104cd57600080fd5b506102cf600681565b604080517f09a36cedee5cdca9c8804bc3bd501c303082427c9156e7b1f46a65c28e17ce586020808301919091528183018b9052606082018a905273ffffffffffffffffffffffffffffffffffffffff8981166080840152881660a083015260c08083018890528351808403909101815260e0830190935282519201919091207f19010000000000000000000000000000000000000000000000000000000000006101008301527f0000000000000000000000000000000000000000000000000000000000000000610102830152610122820152600090819060019061014201604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff881690820152606081018690526080810185905260a0016020604051602081039080840390855afa158015610632573d6000803e3d6000fd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015173ffffffffffffffffffffffffffffffffffffffff908116908916149250505098975050505050505050565b6106938334843385610dbd565b505050565b6106a5848484338561083b565b50505050565b604080517fad247288102f13699d9a6cafb9cfb8fce14f10334c0f638ba03889ab655fc6e660208201529081018890526060810187905273ffffffffffffffffffffffffffffffffffffffff8616608082015260a081018590523360c082015260009081906001907f00000000000000000000000000000000000000000000000000000000000000009060e001604051602081830303815290604052805190602001206040516020016107909291907f190100000000000000000000000000000000000000000000000000000000000081526002810192909252602282015260420190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff881690820152606081018690526080810185905260a0016020604051602081039080840390855afa15801561080c573d6000803e3d6000fd5b5050506020604051035190506108258989838a8a610efc565b61082f3389611064565b98975050505050505050565b43811115610875576040517f2782367700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6108828585858585611158565b5050505050565b8034116108c2576040517f8e7f710600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6108d8846108d083346117c1565b853386610dbd565b6106a58382611064565b6106a58434858585610dbd565b6108ff88888888888888886111f4565b6109098688611064565b5050505050505050565b60008088815b818110156109ab5789898281811061093357610933611801565b90506020020135925061099f8c8c8381811061095157610951611801565b9050602002013584338b8b8681811061096c5761096c611801565b90506020020160208101906109819190611830565b8a8a8781811061099357610993611801565b90506020020135610efc565b92820192600101610919565b50506109b73383611064565b50505050505050505050565b6106a584843385855b6109d98585858585610efc565b6108828385611064565b60008082815b81811015610b7f57858582818110610a0357610a03611801565b905060e002016020013592506000801b868683818110610a2557610a25611801565b905060e0020160a0013514610b0757610b02868683818110610a4957610a49611801565b905060e00201600001358433898986818110610a6757610a67611801565b905060e002016040016020810190610a7f9190611830565b8a8a87818110610a9157610a91611801565b905060e00201606001358b8b88818110610aad57610aad611801565b905060e002016080016020810190610ac59190611854565b8c8c89818110610ad757610ad7611801565b905060e0020160a001358d8d8a818110610af357610af3611801565b905060e0020160c001356111f4565b610b73565b610b73868683818110610b1c57610b1c611801565b905060e00201600001358433898986818110610b3a57610b3a611801565b905060e002016040016020810190610b529190611830565b8a8a87818110610b6457610b64611801565b905060e0020160600135610efc565b928201926001016109e9565b50506106a53383611064565b604080517fb58a7c79b5c8052bb2d380096e39f2ed848c68cdd21cb69f6ab5152ade2629266020808301919091528183018b9052606082018a905273ffffffffffffffffffffffffffffffffffffffff8916608083015260a08083018890528351808403909101815260c0830190935282519201919091207f190100000000000000000000000000000000000000000000000000000000000060e08301527f000000000000000000000000000000000000000000000000000000000000000060e283015261010282015260009060019061012201604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff871690820152606081018590526080810184905260a0016020604051602081039080840390855afa158015610cdb573d6000803e3d6000fd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015191505073ffffffffffffffffffffffffffffffffffffffff811615801590610d5657508673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16145b610d8c576040517f8baa579f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b610d998989898989611158565b505050505050505050565b610db48787873388888888610b8b565b50505050505050565b60008411610df7576040517f1f2a200500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b604080518681526020808201879052818301869052606082018590526080820184905260a09091206000818152918290529190205460ff1615610e66576040517f734530ce00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000818152602081815260409182902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00166001179055815187815290810184905273ffffffffffffffffffffffffffffffffffffffff858116929087169189917f15b4b8206809535e547317cd5cedc86cff6e7d203551f93701786ddaf14fd9f9910160405180910390a4505050505050565b6000600286604051602001610f1391815260200190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe081840301815290829052610f4b9161186f565b602060405180830381855afa158015610f68573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610f8b919061189e565b905080610fc4576040517f8b8dc8b000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6040805182815260208101879052908101859052606081018490526080810183905260a09020610ff38161136f565b6000818152602081815260409182902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00169055905188815283917f5664142af3dcfc3dc3de45a43f75c746bd1d8c11170a5037fdf98bdb35775137910160405180910390a250505050505050565b60008273ffffffffffffffffffffffffffffffffffffffff168260405160006040518083038185875af1925050503d80600081146110be576040519150601f19603f3d011682016040523d82523d6000602084013e6110c3565b606091505b5050905080610693576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602860248201527f5472616e7366657248656c7065723a20636f756c64206e6f74207472616e736660448201527f6572204574686572000000000000000000000000000000000000000000000000606482015260840160405180910390fd5b6040805186815260208101869052908101849052606081018390526080810182905260a090206111878161136f565b60008181526020819052604080822080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001690555187917f3fbd469ec3a5ce074f975f76ce27e727ba21c99176917b97ae2e713695582a1291a26111ec8386611064565b505050505050565b604080516000815260208101899052908101879052606081018690526080810185905260a090206112248161136f565b600060028a60405160200161123b91815260200190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0818403018152908290526112739161186f565b602060405180830381855afa158015611290573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906112b3919061189e565b90506112c5818a8a8a8a8a8a8a6104d6565b6112fb576040517f8baa579f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000828152602081815260409182902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0016905590518b815282917f5664142af3dcfc3dc3de45a43f75c746bd1d8c11170a5037fdf98bdb35775137910160405180910390a250505050505050505050565b60008181526020819052604090205460ff166113b7576040517f5ec69df000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b50565b73ffffffffffffffffffffffffffffffffffffffff811681146113b757600080fd5b803560ff811681146113ed57600080fd5b919050565b600080600080600080600080610100898b03121561140f57600080fd5b88359750602089013596506040890135611428816113ba565b95506060890135611438816113ba565b94506080890135935061144d60a08a016113dc565b979a969950949793969295929450505060c08201359160e0013590565b60008060006060848603121561147f57600080fd5b833592506020840135611491816113ba565b929592945050506040919091013590565b600080600080608085870312156114b857600080fd5b843593506020850135925060408501356114d1816113ba565b9396929550929360600135925050565b600080600080600080600060e0888a0312156114fc57600080fd5b87359650602088013595506040880135611515816113ba565b94506060880135935061152a608089016113dc565b9699959850939692959460a0840135945060c09093013592915050565b600080600080600060a0868803121561155f57600080fd5b85359450602086013593506040860135611578816113ba565b92506060860135611588816113ba565b949793965091946080013592915050565b600080600080608085870312156115af57600080fd5b8435935060208501356115c1816113ba565b93969395505050506040820135916060013590565b600080600080608085870312156115ec57600080fd5b8435935060208501356115fe816113ba565b925060408501356114d1816113ba565b60008083601f84011261162057600080fd5b50813567ffffffffffffffff81111561163857600080fd5b6020830191508360208260051b850101111561165357600080fd5b9250929050565b6000806000806000806000806080898b03121561167657600080fd5b883567ffffffffffffffff81111561168d57600080fd5b6116998b828c0161160e565b909950975050602089013567ffffffffffffffff8111156116b957600080fd5b6116c58b828c0161160e565b909750955050604089013567ffffffffffffffff8111156116e557600080fd5b6116f18b828c0161160e565b909550935050606089013567ffffffffffffffff81111561171157600080fd5b61171d8b828c0161160e565b999c989b5096995094979396929594505050565b60006020828403121561174357600080fd5b5035919050565b6000806020838503121561175d57600080fd5b823567ffffffffffffffff81111561177457600080fd5b8301601f8101851361178557600080fd5b803567ffffffffffffffff81111561179c57600080fd5b85602060e0830284010111156117b157600080fd5b6020919091019590945092505050565b818103818111156117fb577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60006020828403121561184257600080fd5b813561184d816113ba565b9392505050565b60006020828403121561186657600080fd5b61184d826113dc565b6000825160005b818110156118905760208186018101518583015201611876565b506000920191825250919050565b6000602082840312156118b057600080fd5b505191905056fea2646970667358221220f57938ec0b6615437741195891470e93960e3d32907a1c088b9aa03ba09880b764736f6c63430008210033

  # ERC20Swap
  deploy_contract 0x7f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60c09081527f53904d715aff4cbf81a576b4cc3901f2c5f3e7c245cad96f11bec6c197b05ea260e0527fe455bf8ea6e7463a1046a0b52804526e119b4bf5136279614e0b1e8e296a4e2d610100524661012052306101405260a0808052610160604052902060805234801561009457600080fd5b50608051611bfc6100c5600039600081816101ce015281816107de01528181610a420152610c3e0152611bfc6000f3fe6080604052600436106101755760003560e01c806391644b2b116100cb578063cd413efa1161007f578063ebb7af9211610059578063ebb7af921461048c578063fb35dd96146104c0578063ffa1ad74146104e057600080fd5b8063cd413efa1461041c578063e64fafcc1461043c578063eb84e7f21461045c57600080fd5b8063b2b78df8116100b0578063b2b78df8146103a4578063b8080ab8146103e9578063bc586b28146103fc57600080fd5b806391644b2b14610350578063a9ab4d5b1461037057600080fd5b80635073c2771161012d5780637beb9d6d116101075780637beb9d6d146102c95780638579dc5f146103105780638b4f3c231461033057600080fd5b80635073c2771461024357806354fd4d5014610277578063627b8bb71461029957600080fd5b80633644e5151161015e5780633644e515146101bc578063365047211461020357806341bc63701461022357600080fd5b80630e5bbd591461017a578063107e1bb31461019c575b600080fd5b34801561018657600080fd5b5061019a61019536600461173e565b6104f5565b005b3480156101a857600080fd5b5061019a6101b73660046117bb565b610545565b3480156101c857600080fd5b506101f07f000000000000000000000000000000000000000000000000000000000000000081565b6040519081526020015b60405180910390f35b34801561020f57600080fd5b5061019a61021e366004611849565b61056c565b34801561022f57600080fd5b5061019a61023e36600461189b565b610581565b34801561024f57600080fd5b506101f07fb13bddd37ac9193ef6fd7865d7fcfd2255978b29aaf7317aac327fcb9c53951b81565b34801561028357600080fd5b5060065b60405160ff90911681526020016101fa565b3480156102a557600080fd5b506102b96102b43660046117bb565b61072c565b60405190151581526020016101fa565b3480156102d557600080fd5b506101f06102e436600461173e565b604080519687526020870195909552938501929092526060840152608083015260a082015260c0902090565b34801561031c57600080fd5b5061019a61032b366004611971565b6108e6565b34801561033c57600080fd5b5061019a61034b3660046117bb565b610999565b34801561035c57600080fd5b5061019a61036b366004611849565b610bbe565b34801561037c57600080fd5b506101f07ff06c1ed74d5a145979b4b0602a00298e700feb0c04a27a49be9b6f0e7a4349dd81565b3480156103b057600080fd5b506103c46103bf366004611a5d565b610bcc565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016101fa565b61019a6103f7366004611849565b610d68565b34801561040857600080fd5b5061019a61041736600461173e565b610d80565b34801561042857600080fd5b5061019a610437366004611849565b610d99565b34801561044857600080fd5b5061019a61045736600461173e565b610da7565b34801561046857600080fd5b506102b9610477366004611ad5565b60006020819052908152604090205460ff1681565b34801561049857600080fd5b506101f07f88d2eb81eeaf48c24a8e0c241c49b9f515812cf57db155ee3bba213131a67cf181565b3480156104cc57600080fd5b5061019a6104db366004611a5d565b610f06565b3480156104ec57600080fd5b50610287600681565b4381111561052f576040517f2782367700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b61053d868686868686610f21565b505050505050565b610556898989898989898989610fbd565b61056187878a611141565b505050505050505050565b61057a8585858533866104f5565b5050505050565b60008082815b8181101561071f578585828181106105a1576105a1611aee565b905060e002016020013592506000801b8686838181106105c3576105c3611aee565b905060e0020160a00135146106a6576106a18686838181106105e7576105e7611aee565b905060e00201600001358489338a8a8781811061060657610606611aee565b905060e00201604001602081019061061e9190611b1d565b8b8b8881811061063057610630611aee565b905060e00201606001358c8c8981811061064c5761064c611aee565b905060e0020160800160208101906106649190611b41565b8d8d8a81811061067657610676611aee565b905060e0020160a001358e8e8b81811061069257610692611aee565b905060e0020160c00135610fbd565b610713565b6107138686838181106106bb576106bb611aee565b905060e00201600001358489338a8a878181106106da576106da611aee565b905060e0020160400160208101906106f29190611b1d565b8b8b8881811061070457610704611aee565b905060e00201606001356112d5565b92820192600101610587565b505061057a853384611141565b604080517fb13bddd37ac9193ef6fd7865d7fcfd2255978b29aaf7317aac327fcb9c53951b6020808301919091528183018c9052606082018b905273ffffffffffffffffffffffffffffffffffffffff8a8116608084015289811660a0840152881660c083015260e080830188905283518084039091018152610100830190935282519201919091207f19010000000000000000000000000000000000000000000000000000000000006101208301527f0000000000000000000000000000000000000000000000000000000000000000610122830152610142820152600090819060019061016201604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff881690820152606081018690526080810185905260a0016020604051602081039080840390855afa158015610891573d6000803e3d6000fd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015173ffffffffffffffffffffffffffffffffffffffff90811690891614925050509998505050505050505050565b60008088815b8181101561097f5789898281811061090657610906611aee565b9050602002013592506109738c8c8381811061092457610924611aee565b90506020020135848f338c8c8781811061094057610940611aee565b90506020020160208101906109559190611b1d565b8b8b8881811061096757610967611aee565b905060200201356112d5565b928201926001016108ec565b505061098c8b3384611141565b5050505050505050505050565b604080517ff06c1ed74d5a145979b4b0602a00298e700feb0c04a27a49be9b6f0e7a4349dd6020808301919091528183018c9052606082018b905273ffffffffffffffffffffffffffffffffffffffff8a81166080840152891660a083015260c08083018890528351808403909101815260e0830190935282519201919091207f19010000000000000000000000000000000000000000000000000000000000006101008301527f000000000000000000000000000000000000000000000000000000000000000061010283015261012282015260009060019061014201604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff871690820152606081018590526080810184905260a0016020604051602081039080840390855afa158015610af3573d6000803e3d6000fd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015191505073ffffffffffffffffffffffffffffffffffffffff811615801590610b6e57508673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16145b610ba4576040517f8baa579f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b610bb28a8a8a8a8a8a610f21565b50505050505050505050565b61057a858585853386610da7565b604080517f88d2eb81eeaf48c24a8e0c241c49b9f515812cf57db155ee3bba213131a67cf160208201529081018990526060810188905273ffffffffffffffffffffffffffffffffffffffff8088166080830152861660a082015260c081018590523360e082015260009081906001907f0000000000000000000000000000000000000000000000000000000000000000906101000160405160208183030381529060405280519060200120604051602001610cba9291907f190100000000000000000000000000000000000000000000000000000000000081526002810192909252602282015260420190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff881690820152606081018690526080810185905260a0016020604051602081039080840390855afa158015610d36573d6000803e3d6000fd5b505050602060405103519050610d508a8a8a848b8b6112d5565b610d5b88338b611141565b9998505050505050505050565b610d76858585853386610da7565b61057a8234611445565b610d8e8686868686866112d5565b61053d848487611141565b61057a858585338686610d80565b60008511610de1576040517f1f2a200500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b604080518781526020808201889052818301879052606082018690526080820185905260a0820184905260c09091206000818152918290529190205460ff1615610e57576040517f734530ce00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000818152602081815260409182902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00166001179055815188815273ffffffffffffffffffffffffffffffffffffffff88811692820192909252918201849052848116919086169089907fa98eaa2bd8230d87a1a4c356f5c1d41cb85ff88131122ec8b1931cb9d31ae1459060600160405180910390a4610efd8533308961153a565b50505050505050565b610f17888888883389898989610999565b5050505050505050565b6040805187815260208101879052908101859052606081018490526080810183905260a0810182905260c09020610f57816116d1565b60008181526020819052604080822080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001690555188917f3fbd469ec3a5ce074f975f76ce27e727ba21c99176917b97ae2e713695582a1291a2610efd858488611141565b6040805160008152602081018a9052908101889052606081018790526080810186905260a0810185905260c09020610ff4816116d1565b600060028b60405160200161100b91815260200190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529082905261104391611b5c565b602060405180830381855afa158015611060573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906110839190611b8b565b9050611096818b8b8b8b8b8b8b8b61072c565b6110cc576040517f8baa579f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000828152602081815260409182902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0016905590518c815282917f5664142af3dcfc3dc3de45a43f75c746bd1d8c11170a5037fdf98bdb35775137910160405180910390a25050505050505050505050565b6040805173ffffffffffffffffffffffffffffffffffffffff8481166024830152604480830185905283518084039091018152606490920183526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fa9059cbb0000000000000000000000000000000000000000000000000000000017905291516000928392908716916111d89190611b5c565b6000604051808303816000865af19150503d8060008114611215576040519150601f19603f3d011682016040523d82523d6000602084013e61121a565b606091505b50915091508180156112445750805115806112445750808060200190518101906112449190611ba4565b61057a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602f60248201527f5472616e7366657248656c7065723a20636f756c64206e6f74207472616e736660448201527f657220455243323020746f6b656e73000000000000000000000000000000000060648201526084015b60405180910390fd5b60006002876040516020016112ec91815260200190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529082905261132491611b5c565b602060405180830381855afa158015611341573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906113649190611b8b565b90508061139d576040517f8b8dc8b000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6040805182815260208101889052908101869052606081018590526080810184905260a0810183905260c090206113d3816116d1565b6000818152602081815260409182902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00169055905189815283917f5664142af3dcfc3dc3de45a43f75c746bd1d8c11170a5037fdf98bdb35775137910160405180910390a25050505050505050565b60008273ffffffffffffffffffffffffffffffffffffffff168260405160006040518083038185875af1925050503d806000811461149f576040519150601f19603f3d011682016040523d82523d6000602084013e6114a4565b606091505b5050905080611535576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602860248201527f5472616e7366657248656c7065723a20636f756c64206e6f74207472616e736660448201527f657220457468657200000000000000000000000000000000000000000000000060648201526084016112cc565b505050565b6040805173ffffffffffffffffffffffffffffffffffffffff85811660248301528481166044830152606480830185905283518084039091018152608490920183526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167f23b872dd0000000000000000000000000000000000000000000000000000000017905291516000928392908816916115d99190611b5c565b6000604051808303816000865af19150503d8060008114611616576040519150601f19603f3d011682016040523d82523d6000602084013e61161b565b606091505b50915091508180156116455750805115806116455750808060200190518101906116459190611ba4565b61053d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603360248201527f5472616e7366657248656c7065723a20636f756c64206e6f74207472616e736660448201527f657246726f6d20455243323020746f6b656e730000000000000000000000000060648201526084016112cc565b60008181526020819052604090205460ff16611719576040517f5ec69df000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b50565b73ffffffffffffffffffffffffffffffffffffffff8116811461171957600080fd5b60008060008060008060c0878903121561175757600080fd5b863595506020870135945060408701356117708161171c565b935060608701356117808161171c565b925060808701356117908161171c565b9598949750929591949360a090920135925050565b803560ff811681146117b657600080fd5b919050565b60008060008060008060008060006101208a8c0312156117da57600080fd5b8935985060208a0135975060408a01356117f38161171c565b965060608a01356118038161171c565b955060808a01356118138161171c565b945060a08a0135935061182860c08b016117a5565b989b979a50959894979396929550929360e081013593506101000135919050565b600080600080600060a0868803121561186157600080fd5b8535945060208601359350604086013561187a8161171c565b9250606086013561188a8161171c565b949793965091946080013592915050565b6000806000604084860312156118b057600080fd5b83356118bb8161171c565b9250602084013567ffffffffffffffff8111156118d757600080fd5b8401601f810186136118e857600080fd5b803567ffffffffffffffff8111156118ff57600080fd5b86602060e08302840101111561191457600080fd5b939660209190910195509293505050565b60008083601f84011261193757600080fd5b50813567ffffffffffffffff81111561194f57600080fd5b6020830191508360208260051b850101111561196a57600080fd5b9250929050565b600080600080600080600080600060a08a8c03121561198f57600080fd5b893561199a8161171c565b985060208a013567ffffffffffffffff8111156119b657600080fd5b6119c28c828d01611925565b90995097505060408a013567ffffffffffffffff8111156119e257600080fd5b6119ee8c828d01611925565b90975095505060608a013567ffffffffffffffff811115611a0e57600080fd5b611a1a8c828d01611925565b90955093505060808a013567ffffffffffffffff811115611a3a57600080fd5b611a468c828d01611925565b915080935050809150509295985092959850929598565b600080600080600080600080610100898b031215611a7a57600080fd5b88359750602089013596506040890135611a938161171c565b95506060890135611aa38161171c565b945060808901359350611ab860a08a016117a5565b979a969950949793969295929450505060c08201359160e0013590565b600060208284031215611ae757600080fd5b5035919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600060208284031215611b2f57600080fd5b8135611b3a8161171c565b9392505050565b600060208284031215611b5357600080fd5b611b3a826117a5565b6000825160005b81811015611b7d5760208186018101518583015201611b63565b506000920191825250919050565b600060208284031215611b9d57600080fd5b5051919050565b600060208284031215611bb657600080fd5b81518015158114611b3a57600080fdfea26469706673582212208a50d86061cb54e0a09dc7bd5d9821c6db36890791b26c3ccdc2289b98e4ce4564736f6c63430008210033
}

